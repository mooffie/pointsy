#! /usr/bin/env lua

local lapp = require 'pl.lapp'

require('pl.app').require_here()  -- lets us 'require' our own modules.

local IM = require('imagemagick')

------------------------------------------------------------------------------

local args = lapp [[
Joins two images.

** You probably won't call this program directly but via 'scanjoin'. **

Arguments:

  <data_file> (string)  The pathname of the Lua data-file generated by "pointsy".
  <img_trg>   (string)  The pathname of the new joined image to create.
]]

------------------------------------------------------------------------------

local function join(data)
  local f1 = data[1]
  local f2 = data[2]
  local f1x, f1y = f1.points[1].x, f1.points[1].y
  local f2x, f2y = f2.points[1].x, f2.points[1].y

  -- adjust horizontally
  if f2x < f1x then
    f2.filepath = IM.add_border_left(f2.filepath, f1x - f2x, 'red')
  elseif f1x < f2x then
    f1.filepath = IM.add_border_left(f1.filepath, f2x - f1x, 'red')
  end

  -- cut bottom/top.
  f1.filepath = IM.cut_bottom(f1.filepath, f1.height - f1y)
  f2.filepath = IM.cut_top(f2.filepath, f2y)

  -- concat.
  return IM.vertical_concat(f1.filepath, f2.filepath)
end

------------------------------------------------------------------------------

local data = dofile(args.data_file)
IM.utils.pp(data)

local output = join(data)
IM.convert(output, args.img_trg)
