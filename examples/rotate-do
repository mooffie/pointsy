#! /usr/bin/env lua

local lapp = require 'pl.lapp'

require('pl.app').require_here()  -- lets us 'require' our own modules.

local IM = require('imagemagick')

------------------------------------------------------------------------------

local args = lapp [[
Rotates an image.

** You probably won't call this program directly but via 'rotate'. **

Arguments:

  <data_file> (string)  The pathname of the Lua data-file generated by "pointsy".
  <img_trg>   (string)  The pathname of the new rotated image to create.
]]

------------------------------------------------------------------------------

local function find_angle(x1, y1, x2, y2)
  local a = math.atan2(y2 - y1, x2 - x1)
  return math.deg(a)
end

local function rotate(data)
  local f = data[1]
  local p1 = f.points[1]
  local p2 = f.points[2]
  local angle = find_angle(p1.x, p1.y, p2.x, p2.y)
  print('angle is ', angle)
  return IM.rotate(f.filepath, -angle)
end

------------------------------------------------------------------------------

local data = dofile(args.data_file)
IM.utils.pp(data)

local output = rotate(data)
IM.convert(output, args.img_trg)
