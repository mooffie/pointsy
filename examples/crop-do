#! /usr/bin/env lua

local lapp = require 'pl.lapp'

require('pl.app').require_here()  -- lets us 'require' our own modules.

local IM = require('imagemagick')

------------------------------------------------------------------------------

local args = lapp [[
Crops an image.

** You probably won't call this program directly but via 'crop'. **

Arguments:

  <data_file> (string)  The pathname of the Lua data-file generated by "pointsy".
  <img_trg>   (string)  The pathname of the new cropped image to create.
]]

------------------------------------------------------------------------------

local function crop(data)
  local f = data[1]
  local p1 = f.points[1]
  local p2 = f.points[2]

  return IM.crop(f.filepath, p1.x, p1.y, p2.x, p2.y)
end

------------------------------------------------------------------------------

local data = dofile(args.data_file)
IM.utils.pp(data)

local output = crop(data)
IM.convert(output, args.img_trg)
