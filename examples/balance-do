#! /usr/bin/env lua

local lapp = require 'pl.lapp'

require('pl.app').require_here()  -- lets us 'require' our own modules.

local IM = require('imagemagick')

------------------------------------------------------------------------------

local args = lapp [[
Balances an image.

** You probably won't call this program directly but via 'balance'. **

Arguments:

  <data_file> (string)  The pathname of the Lua data-file generated by "pointsy".
  <img_trg>   (string)  The pathname of the new balanced image to create.
]]

------------------------------------------------------------------------------

local function balance(data)
  local f = data[1]
  local p1 = f.points[1]
  local p2 = f.points[2]

  local cropped = IM.crop(f.filepath, p1.x, p1.y, p2.x, p2.y)
  local r, g, b = IM.average(cropped)
  --print(r, g, b)
  local rx, gx, bx = 1.0, r/g, r/b
  --print(rx, gx, bx)
  return IM.multiply(f.filepath, rx, gx, bx)
end

------------------------------------------------------------------------------

local data = dofile(args.data_file)
IM.utils.pp(data)

local output = balance(data)
IM.convert(output, args.img_trg)
